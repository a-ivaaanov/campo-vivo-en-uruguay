# Архитектура проекта CampoVivoenUruguay

## Общая структура

Проект CampoVivoenUruguay организован следующим образом:

```
CampoVivoenUruguay/
├── app/                     # Основной код приложения
│   ├── parsers/             # Парсеры для разных сайтов
│   │   ├── base.py          # Базовый класс парсера
│   │   ├── mercadolibre.py  # Парсер MercadoLibre
│   │   ├── infocasas.py     # Парсер InfoCasas
│   │   └── gallito.py       # Парсер Gallito
│   ├── utils/               # Утилиты и вспомогательные функции
│   │   ├── ai_selectors.py  # ИИ для гибкого поиска элементов
│   │   ├── duplicate_checker.py # Проверка дубликатов объявлений 
│   │   └── proxy_manager.py # Управление прокси
│   ├── models.py            # Модели данных (Listing)
│   ├── telegram_poster.py   # Отправка объявлений в Telegram
│   ├── listing_manager.py   # Управление списками объявлений
│   └── base64_handler.py    # Обработка изображений в формате base64
├── config/                  # Конфигурационные файлы
│   ├── .env.example         # Пример конфигурации
│   └── settings.py          # Загрузка настроек
├── tools/                   # Вспомогательные скрипты
│   ├── check_proxy.py       # Проверка настроек прокси
│   └── test_telegram.py     # Тестирование отправки в Telegram
├── systemd/                 # Настройки для автозапуска через systemd
├── data/                    # Данные и кэш
├── logs/                    # Логи
├── errors/                  # Сведения об ошибках
└── images/                  # Сохраненные изображения
```

## Основные компоненты

### 1. Парсеры (app/parsers/)

Все парсеры наследуются от базового класса `BaseParser`, определенного в `base.py`. Этот класс предоставляет общую функциональность:
- Инициализация и закрытие Playwright
- Управление сессиями браузера
- Обработка ошибок и повторные попытки
- Базовые методы для навигации

Специализированные парсеры:
- `mercadolibre.py` - парсер для сайта MercadoLibre.com.uy
- `infocasas.py` - парсер для InfoCasas.com.uy
- `gallito.py` - парсер для Gallito.com.uy

### 2. Модели данных (app/models.py)

Содержит класс `Listing`, определяющий структуру объявления с такими полями как:
- URL, заголовок, описание
- Цена, площадь, местоположение
- Изображения
- Метаданные (дата публикации, дата сбора данных)

### 3. Telegram-интеграция (app/telegram_poster.py, app/telegram_sender.py)

Обеспечивает отправку объявлений в Telegram-канал:
- Форматирование сообщений с эмодзи и разметкой
- Загрузка и отправка изображений
- Обработка ошибок и повторные попытки

### 4. Утилиты (app/utils/)

- `ai_selectors.py` - интеллектуальный поиск элементов на странице
- `duplicate_checker.py` - фильтрация дубликатов объявлений
- `proxy_manager.py` - управление прокси-серверами

### 5. Точки входа

- `main.py` - основной скрипт для запуска парсеров с отправкой в Telegram
- `run.py` - утилита для быстрого запуска отдельных парсеров
- `cron_scheduler.py` - планировщик для запуска по расписанию

## Потоки данных

1. **Сбор данных**:
   - Парсеры извлекают базовую информацию из списка объявлений
   - При необходимости открывают детальные страницы для получения дополнительной информации
   
2. **Обработка данных**:
   - Данные проверяются на дубликаты
   - Изображения скачиваются и кэшируются
   - Информация форматируется для отправки

3. **Отправка в Telegram**:
   - Форматирование сообщений для Telegram
   - Отправка изображений и текста
   - Обработка ошибок и повторные попытки

## Расширение

Для добавления нового парсера:
1. Создайте новый файл в директории `app/parsers/`
2. Унаследуйте класс от `BaseParser`
3. Реализуйте необходимые методы:
   - `_get_page_url(page_number)` - формирование URL страницы поиска
   - `_extract_listings_from_page(page)` - извлечение объявлений со страницы поиска
   - `_extract_listing_details(page, listing)` - извлечение деталей объявления
4. Добавьте новый парсер в список `PARSERS_TO_RUN` в конфигурации

## Конфигурация

Основные настройки хранятся в файлах `.env` и `config/.env`:
- Токен бота и ID канала Telegram
- Настройки прокси
- Параметры запуска парсеров
- Интервалы проверки новых объявлений 