# Улучшения парсера MercadoLibre

## Улучшенная защита от блокировок

### 1. Ротация прокси
- Добавлена возможность ротации прокси-серверов
- Настройка через `ALTERNATIVE_PROXY_SERVERS` в `.env`
- При третьей попытке запроса автоматически меняется прокси

### 2. Рандомизация User-Agent
- Добавлен список различных User-Agent для имитации разных браузеров и устройств
- При каждом запуске браузера выбирается случайный User-Agent
- Поддержка мобильных и десктопных устройств

### 3. Улучшенная маскировка браузера
- Кастомные HTTP-заголовки для имитации реального браузера
- Настройка геолокации (Уругвай, Монтевидео)
- Настройка часового пояса (America/Montevideo)
- Эмуляция WebGL с уникальными идентификаторами для обхода fingerprinting

## Улучшенная обработка ошибок

### 1. Повторные попытки с экспоненциальной задержкой
- Система повторных попыток при ошибках страниц с деталями объявлений
- Экспоненциальное увеличение времени задержки между попытками
- Рандомизация задержек для имитации человеческого поведения

### 2. Диагностическая информация
- Сохранение скриншотов при ошибках
- Сохранение HTML-кода страниц для анализа
- Улучшенное логирование с отладочной информацией

## Улучшенное извлечение данных

### 1. Обработка разных форматов площадей
- Поддержка разных форматов (м², га, гектары)
- Извлечение и нормализация числовых значений
- Обработка диапазонов площадей (например, "10-15 м²")

### 2. Улучшенное распознавание коммуникаций
- Словарь ключевых слов для определения коммуникаций
- Контекстный анализ упоминания коммуникаций в описании
- Проверка отрицаний (например, "нет воды")

### 3. Извлечение дополнительных характеристик
- Распознавание зонирования
- Извлечение информации о топографии
- Данные о доступности (дороги, транспорт)

## Гибкая конфигурация

### 1. Расширенные настройки окружения
- Конфигурация прокси-серверов через .env
- Настройка таймаутов и задержек
- Конфигурация параметров парсинга

### 2. Улучшенный тестовый скрипт
- Проверка различных форматов данных
- Сохранение результатов в JSON
- Информативные логи о ходе выполнения

## Как работает парсер MercadoLibre

1. **Инициализация**: 
   - Создается экземпляр `MercadoLibreParser`
   - Случайным образом выбирается User-Agent и прокси
   - Инициализируется браузер Playwright с защитой от fingerprinting

2. **Навигация и поиск**:
   - Переход на страницу поиска объявлений
   - Обработка cookie и диалогов
   - Извлечение карточек объявлений с использованием AI-селекторов

3. **Обработка карточек объявлений**:
   - Извлечение базовой информации (URL, заголовок, цена)
   - Очистка и нормализация данных
   - Сохранение результатов в структуру данных `Listing`

4. **Обработка деталей объявления**:
   - Переход на страницу с детальной информацией
   - Извлечение полного описания, площади, коммуникаций и других характеристик
   - В случае ошибки - повторные попытки с разными прокси

5. **Отправка в Telegram**:
   - Форматирование данных для Telegram (Markdown)
   - Отправка изображения и текста в указанный канал
   - Сохранение ID отправленных объявлений для избежания дубликатов

## Обработка разных форматов данных

### Площадь участка
- "500 m²" → "500 m²"
- "2 hectáreas" → "2 ha"
- "500 - 1000 m²" → "500 m² - 1000 m²"
- "entre 1 y 2 ha" → "1 ha - 2 ha"

### Коммуникации
- "agua corriente, luz" → "Вода, Электричество"
- "sin luz, pero con agua" → "Вода"
- "agua de pozo" → "Вода"

## Примеры использования

### Базовый запуск:
```python
parser = MercadoLibreParser()
listings = await parser.run(max_pages=2, headless=True)
```

### Запуск с пользовательскими настройками:
```python
smartproxy_config = {
    "server": "uy.smartproxy.com:15001",
    "user_pattern": "user",
    "password": "pass",
    "alternative_servers": [
        "us.smartproxy.com:15001",
        "ar.smartproxy.com:15001"
    ]
}

parser = MercadoLibreParser(
    smartproxy_config=smartproxy_config,
    headless_mode=True,
    max_retries=5,
    request_delay_range=(5, 10)
)

listings = await parser.run(max_pages=3)
```
